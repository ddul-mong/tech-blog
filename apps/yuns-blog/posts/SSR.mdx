---
title: Next.jsì™€ React Queryë¡œ SSR ì‚¬ìš©í•˜ê¸°
description: Next.jsì™€ React Queryë¡œ SSR ì‚¬ìš©í•˜ê¸°
thumbnail: example
categories: [frontend, react]
writeDate: 2024-04-09 22:05:42
releaseDate: 2024-04-09 22:05:42
---

> ì´ ê¸€ì€ app router ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

Next.js í”„ë¡œì íŠ¸ì—ì„œ react queryë¥¼ ì‚¬ìš©í•´ì„œ API ì—°ê²°ì„ í•˜ë‹¤ë³´ë‹ˆ í˜ì´ì§€ë“¤ì´ ì „ë¶€ CSRì´ ë˜ì–´ ë²„ë ¸ë‹¤. SSR í•´ë³´ë ¤ê³  Next.jsì“°ëŠ”ê±´ë° ì´ê±´ ì•„ë‹ˆì§€ ì•Šë‚˜ í•´ì„œ í•´ê²°ì±…ì„ ì°¾ì•„ë³´ì•˜ë‹¤.

> react queryë¥¼ CSRì—ì„œ ì“¸ë•Œ ìƒê¸°ëŠ” ë¡œë”©ì‹œê°„ì´ ë„ˆë¬´ ì‹«ì—ˆë‹¤.
<img src="https://velog.velcdn.com/images/shrewslampe/post/5737821e-66de-4775-808d-1de66024267e/image.gif"/>



react queryì˜ ê³µì‹ ë¬¸ì„œë¥¼ ì°¾ì•„ë³´ë‹ˆ 2ê°€ì§€ ë°©ì‹ì„ ì œê³µí–ˆë‹¤.

1. `initialData` ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë²„ì—ì„œ fetchí•œ ë°ì´í„° ì‚¬ìš©í•˜ê¸°
2. Hydration API ì‚¬ìš©í•˜ê¸°

ê³µì‹ ë¬¸ì„œì—ì„œëŠ” ì„œë²„ì˜ ìµœì‹  ë°ì´í„° ìœ ì§€í•˜ê¸° ìœ„í•´ í›„ìì˜ ë°©ë²•ì„ ê¶Œì¥í•˜ê³  ìˆê¸°ì— Hydration API ë¥¼ ì‚¬ìš©í–ˆë‹¤.

## [Hydration API](https://tanstack.com/query/v5/docs/framework/react/guides/ssr#using-the-hydration-apis)

### ì ìš©ë²•

Hydration APIì‚¬ìš©ì„ ìœ„í•´ì„œ ë¯¸ë¦¬ ì„¤ì •í•´ì¤˜ì•¼ í•˜ëŠ” ê²ƒë“¤ì´ ìˆë‹¤.

#### ì´ˆê¸° ì„¸íŒ…

``` tsx
// providers/app.tsx
'use client'

import { QueryClient, QueryClientProvider } from "@tanstack/react-query"

function makeQueryClient() {
  return new QueryClient({
    defaultOptions: {
      queries: {
        // SSRì—ì„œëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì¦‰ì‹œ refetchí•˜ëŠ” ê²ƒì„ í”¼í•˜ê¸° ìœ„í•´
        // staleTimeì„ 0ë³´ë‹¤ í¬ê²Œ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.
        staleTime: 60 * 1000,
      },
    },
  })
}

let browserQueryClient: QueryClient | undefined = undefined

function getQueryClient() {
  if (typeof window === 'undefined') {
    // Serverì¼ ê²½ìš°
    // ë§¤ë²ˆ ìƒˆë¡œìš´ queryClientë¥¼ ë§Œë“ ë‹¤.
    return makeQueryClient()
  } else {
    // Browserì¼ ê²½ìš°
    // queryClientê°€ ì¡´ì¬í•˜ì§€ ì•Šì„ ê²½ìš°ì—ë§Œ ìƒˆë¡œìš´ queryClientë¥¼ ë§Œë“ ë‹¤.
    // Reactê°€ ìƒˆ Clientë¥¼ ë§Œë“¤ê²Œ í•˜ê¸° ìœ„í•´ ì¤‘ìš”í•˜ë‹¤.
    if (!browserQueryClient) browserQueryClient = makeQueryClient()
    return browserQueryClient
  }
}

export default function Providers({ children }) {
  // NOTE: queryClientë¥¼ useStateë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ˆê¸°í™” í•˜ë©´ ì•ˆëœë‹¤.
  // suspense boundaryê°€ ì—†ì„ ê²½ìš° Reactì˜ ë Œë”ë§ì´ ì¤‘ë‹¨ë  ìˆ˜ë„ ìˆê³  
  // queryClient ìì²´ë¥¼ íê¸°í•  ìˆ˜ ë„ ìˆë‹¤.
  const queryClient = getQueryClient()

  return (
    <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
  )
}
```
```tsx
// app/layout.tsx
import { AppProvider } from "@/providers/app";

export default function RootLayout({ children }: React.PropsWithChildren) {
  return (
    <html lang="en">
      <body>
        <AppProvider>
          {children}
        </AppProvider>
      </body>
    </html>
  );
}
```
ê¸°ì¡´ì˜ React Query ì„¸íŒ… ë°©ë²•ì€ í´ë¼ì´ì–¸íŠ¸ì—ì„œ QueryClientë¥¼ ìƒì„±í•˜ê³  ì´ë¥¼ ê³„ì† ì´ìš©í–ˆë‹¤. í•˜ì§€ë§Œ prefecthing ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ê²½ìš° ì„œë²„ì—ì„œë„ QueryClientë¥¼ ìƒì„±í•˜ì—¬ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ì„œë²„ì—ì„œ QueryClientë¥¼ ìƒì„±í–ˆì„ ê²½ìš° ë‹¤ì‹œ ìƒì„±í•˜ì§€ ì•Šê²Œ ë¡œë” í•¨ìˆ˜ì— ë¶„ê¸° ì½”ë“œë¥¼ ì‘ì„±í•´ì¤˜ì•¼ ëœë‹¤.

#### ë°ì´í„° prefeching ë° dehydrate (ê° ë¼ìš°í„°ì—ì„œ)

ì‹¤ì œë¡œ ë°ì´í„°ë¥¼ prefechingí•˜ì—¬ ë¯¸ë¦¬ ê°€ì ¸ì˜¤ê³  dehydrateí•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ê² ë‹¤. ìš°ì„  prefetchë¥¼ ìˆ˜í–‰í•˜ê¸° ìœ„í•œ êµ¬ì„±ìš”ì†Œë¥¼ ë§Œë“¤ì–´ ì¤€ë‹¤.

```tsx
// app/posts/layout.tsx
import { dehydrate, HydrationBoundary, QueryClient } from "@tanstack/react-query";
import getPosts from "./posts"

export default async function Layout({ children }: React.PropsWithChildren) {
  const queryClient = new QueryClient();
  await queryClient.prefetchQuery({
    queryKey: ["posts"],
    queryFn: getPosts,
  });

  return (
    <HydrationBoundary state={dehydrate(queryClient)}>
      {children}
    </HydrationBoundary>
  );
}
```
```tsx
// app/posts/page.jsx
"use client"

export default function Posts() {
  // useQueryëŠ” Postsë¿ë§Œì´ ì•„ë‹ˆë¼ ë” ê¹Šì€ ìì‹ì—ì„œë„ ë˜‘ê°™ì´ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
  // ì–´ëŠ ë°©ì‹ì—ì„œë“  ë°ì´í„°ëŠ” ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤.
  const { data } = useQuery({ queryKey: ['posts'], queryFn: getPosts })

  return (
    // dataê°€ ì´ë¯¸ ìºì‹œì— ìˆê¸°ë•Œë¬¸ì— ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•˜ì§€ë§Œ 
    // prettier ë‚˜ eslintëŠ” ì´ ì •ë³´ë¥¼ ëª¨ë¥´ê¸° ë•Œë¬¸ì—
    // ì•„ë˜ì™€ ê°™ì´ ì‚¬ìš©í•˜ê±°ë‚˜ ì˜ˆì™¸ì²˜ë¦¬í•˜ë©´ ëœë‹¤.
    {data && <div>{data.title}</div>}
    )
}
```
ì´ë ‡ê²Œ ì‚¬ìš©í•˜ë©´ Next.jsì™€ React Queryë¥¼ í•¨ê»˜ ì‚¬ìš©í•˜ì—¬ SSRí˜ì´ì§€ë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤. 

ë‹¤ìŒìœ¼ë¡œëŠ” ê° ê³¼ì •ì„ ìì„¸íˆ ì•Œì•„ë³´ì.

## ë™ì‘ê³¼ì •

### prefetching

```tsx
const queryClient = new QueryClient();
await queryClient.prefetchQuery({
  queryKey: ["posts"],
  queryFn: getPosts,
});
```
Layout ì»´í¬ë„ŒíŠ¸ëŠ” ì„œë²„ì—ì„œ QueryClientë¥¼ ìƒì„±í•˜ê³ , prefetchQuery ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ë¹„ë™ê¸°ë¡œ ë¯¸ë¦¬ ê°€ì ¸ì˜¨ë‹¤. ì´ë•Œ ê°€ì ¸ì˜¨ ë°ì´í„°ëŠ” QueryClientì— ìºì‹±ëœë‹¤. 

```tsx
const { data } = useQuery({ queryKey: ['posts'], queryFn: getPosts })
```
prefetchQueryë¥¼ í†µí•´ ìºì‹œëœ ë°ì´í„°ë¥¼ HydrationBoundary ë‚´ë¶€ì—ì„œ í˜¸ì¶œí•  ê²½ìš° ë³„ë„ì˜ api í˜¸ì¶œ ì—†ì´ ìºì‹œëœ ë°ì´í„°ë¥¼ ì„œë²„ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ëœë‹¤. QueryClientëŠ” ì„œë²„ì—ì„œ ìƒì„±ë¬ê¸° ë•Œë¬¸ì— ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ëŠ” HTMLíŒŒì¼ì— í•¨ê»˜ í¬í•¨ë˜ì–´ SSR í˜ì´ì§€ê°€ ìƒì„±ëœë‹¤.


### dehydrate

ìºì‹±ëœ QueryClientì—ì„œ mutationsê³¼ queriesë¥¼ ì¶”ì¶œ í•˜ëŠ” ê³¼ì •ì´ë‹¤.

```tsx
function dehydrate(client, options = {}) {
  const filterMutation = options.shouldDehydrateMutation ?? defaultShouldDehydrateMutation;
  const mutations = client.getMutationCache().getAll().flatMap(
    (mutation) => filterMutation(mutation) ? [dehydrateMutation(mutation)] : []
  );
  const filterQuery = options.shouldDehydrateQuery ?? defaultShouldDehydrateQuery;
  const queries = client.getQueryCache().getAll().flatMap((query) => filterQuery(query) ? [dehydrateQuery(query)] : []);
  return { mutations, queries };
}
```

dehydrate ë©”ì„œë“œì˜ ë‚´ìš©ì„ ë³´ë©´ ì¸ìë¡œ ë°›ì€ QueryClientì—ì„œ mutationsê³¼ queriesë¥¼ ì¶”ì¶œí•´ì„œ ë„˜ê²¨ ì£¼ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤. ì´ë•Œ ì¶”ì¶œ ëœ ë°ì´í„°ëŠ” HydrationBoundaryì—ì„œ ì‚¬ìš©ëœë‹¤.

### HydrationBoundary

HydrationBoundaryëŠ” ë‘ê°€ì§€ ì—­í• ì„ í•œë‹¤.

- HydrationBoundaryëŠ” í•˜ìœ„ì—ì„œ ìºì‹œëœ ë°ì´í„°ë¥¼ ì„œë²„ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•´ì¤€ë‹¤.
- ìºì‹œëœ ë°ì´í„°ì™€ dehydrateëœ ë°ì´í„°ë¥¼ ë¹„êµí•˜ì—¬ ê°€ì¥ ìµœì‹ ì˜ ë°ì´í„°ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤. ë§Œì•½ stateë¥¼ í• ë‹¹í•˜ì§€ ì•Šìœ¼ë©´ ìºì‹œëœ ë°ì´í„°ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•œë‹¤.


HydrationBoundaryì˜ ë‚´ë¶€ ì½”ë“œë¥¼ ë³´ë©´

```tsx
// ... 
for (const dehydratedQuery of queries) {
  const existingQuery = queryCache.get(dehydratedQuery.queryHash);
  if (!existingQuery) {
    newQueries.push(dehydratedQuery);
  } else {
    const hydrationIsNewer = dehydratedQuery.state.dataUpdatedAt > existingQuery.state.dataUpdatedAt;
    const queryAlreadyQueued = hydrationQueue?.find(
    (query) => query.queryHash === dehydratedQuery.queryHash
    );
    if (hydrationIsNewer && (!queryAlreadyQueued || dehydratedQuery.state.dataUpdatedAt > queryAlreadyQueued.state.dataUpdatedAt)) {
      existingQueries.push(dehydratedQuery);
    }
  }
}
// ...
```
ìºì‹œëœ ë°ì´í„°ì™€ dehydrateëœ ë°ì´í„°ë¥¼ ë°ì´í„°ë¥¼ ë¹„êµí•˜ì—¬ ë” ìµœì‹ ì˜ ì •ë³´ë¡œ ìºì‹œë¥¼ ë³€ê²½í•´ì¤€ë‹¤. ì´ë¥¼ í†µí•´ HydrationBoundary í•˜ìœ„ì—ì„œ ì‚¬ìš©ë˜ëŠ” ë°ì´í„°ë“¤ì€ í•­ìƒ ìµœì‹ ì˜ ì •ë³´ë¥¼ ìœ ì§€ í•  ìˆ˜ ìˆê²Œ ëœë‹¤.


## ì ìš© ê²°ê³¼

<img src="https://velog.velcdn.com/images/shrewslampe/post/14f21fe3-feaa-4aa6-ae90-956250eb3858/image.gif"/>


ë ˆì´ì•„ì›ƒì˜ ë³€ê²½ë„ ë¡œë”©ë„ ì—†ì´ ë°”ë¡œë°”ë¡œ ë¡œë”©ì´ ë˜ì„œ ì†ì´ ì‹œì›í•´ì¡Œë‹¤.


> ì°¸ê³ ìë£Œ
[Server Rendering & Hydration - ê³µì‹ë¬¸ì„œ](https://tanstack.com/query/latest/docs/framework/react/guides/ssr)
[Advanced Server Rendering](https://tanstack.com/query/v5/docs/framework/react/guides/advanced-ssr)
[[React-Query] ì„œë²„ì—ì„œ prefetching í•œ ë°ì´í„° ì‚¬ìš©í•˜ê¸° - LESS BUT BETTER](https://soobing.github.io/react/server-rendering-and-react-query/)
[[React-Query] Next.js app routerì—ì„œ ì‚¬ìš©í•˜ë©´ì„œ ê³ ë¯¼í–ˆë˜ ê²ƒë“¤ - LESS BUT BETTER](https://soobing.github.io/react/next-app-router-react-query/)
[[NextJS] SSRë¡œ ì´ˆê¸° í™”ë©´ ë¡œë”© ì†ë„ë¥¼ ë†’ì—¬ë³´ì ğŸš€ (+ React Query) - Youngeui Hong](https://velog.io/@youngeui_hong/NextJS-SSR%EB%A1%9C-%EC%B4%88%EA%B8%B0-%ED%99%94%EB%A9%B4-%EB%A1%9C%EB%94%A9-%EC%86%8D%EB%8F%84%EB%A5%BC-%EB%86%92%EC%97%AC%EB%B3%B4%EC%9E%90)
